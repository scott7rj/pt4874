DROP TABLE ITEM_MENU
/
DROP TABLE MENU
/
CREATE TABLE "MENU"
(
  "ID" NUMBER(4,0) GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 ORDER  NOCYCLE NOT NULL ENABLE,
  "DESCRIPTION" VARCHAR2(50) NOT NULL ENABLE,
  SEQ NUMBER(4,0) DEFAULT 0,
  "ACTIVE" CHAR(1) DEFAULT 'Y',
   CONSTRAINT "MENU_PK" PRIMARY KEY ("ID")
  USING INDEX  ENABLE
)
/
CREATE TABLE "ITEM_MENU"
(
  "ID" NUMBER(4,0) GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 ORDER  NOCYCLE NOT NULL ENABLE,
  "DESCRIPTION" VARCHAR2(50) NOT NULL ENABLE,
  "ID_MENU" NUMBER(4,0) NOT NULL ENABLE,
  "ID_PARENT" NUMBER(4,0) NOT NULL ENABLE,
  "TREE_LEVEL" NUMBER(1,0) DEFAULT 0,
  "SEQ" NUMBER(4,0) DEFAULT 1,
  "URL" VARCHAR2(300) DEFAULT '#',
  "ACTIVE" CHAR(1) DEFAULT 'Y',
   CONSTRAINT "ITEM_MENU_PK" PRIMARY KEY ("ID") USING INDEX  ENABLE
)
/
ALTER TABLE  "ITEM_MENU" ADD CONSTRAINT "ITEM_MENU_FK" FOREIGN KEY ("ID_MENU") REFERENCES  "MENU" ("ID") ENABLE
/
INSERT INTO MENU(DESCRIPTION, SEQ) VALUES('NSGD',1)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT, TREE_LEVEL, SEQ) VALUES('Conta/Contrato',1,0,0,1)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Informações do Contrato',1,1,1,1)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Informações do Contrato em Data Anterior',1,1,1,2)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Situação',1,1,1,3)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Numeração Contas Migradas',1,1,1,4)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Lançamentos Financeiros',1,1,1,5)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Lançamentos não Financeiros',1,1,1,6)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Funcionalidades Especiais',1,1,1,7)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Histórico de Conta/Contrato',1,1,1,8)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Consulta Tarifa Serviço Prestado',1,1,1,9)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Cheques Novos',1,1,1,10)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Cheques',1,11,2,1)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Talão',1,11,2,2)
/
INSERT INTO ITEM_MENU(DESCRIPTION, ID_MENU, ID_PARENT,TREE_LEVEL, SEQ) VALUES('Estoque',1,11,2,3)
/




DECLARE
  l_cursor SYS_REFCURSOR;
BEGIN
  OPEN l_cursor FOR
    SELECT id, description,
           CURSOR(SELECT id, description
                  FROM   item_menu
                  WHERE  id_menu = id
                  ORDER BY level) AS items
    FROM   menu
    ORDER BY description;

  APEX_JSON.initialize_clob_output;

  APEX_JSON.open_object;
  APEX_JSON.write('menus', l_cursor);
  APEX_JSON.close_object;

  DBMS_OUTPUT.put_line(APEX_JSON.get_clob_output);
  APEX_JSON.free_output;
END;
/

DECLARE
  l_cursor SYS_REFCURSOR;
begin
OPEN l_cursor FOR
SELECT id, description, CURSOR(select id, description, "level" from item_menu where id_menu = m.id and url = '#') as items from menu m;
APEX_JSON.initialize_clob_output;
APEX_JSON.open_object;
APEX_JSON.write('menus', l_cursor);
APEX_JSON.close_object;
DBMS_OUTPUT.put_line(APEX_JSON.get_clob_output);
APEX_JSON.free_output;
end;